<!DOCTYPE html>
<html>
<head>
    <title>Test M-Pesa Payment</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; }
        button { background: #28a745; color: white; border: none; cursor: pointer; }
        button:hover { background: #218838; }
        .result { margin-top: 20px; padding: 10px; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Test M-Pesa Payment</h2>
        <p>Use this page to test if payment.php is working</p>
        
        <div>
            <label>Amount (KES):</label>
            <input type="number" id="amount" value="10" min="10">
        </div>
        
        <div>
            <label>Phone (2547XXXXXXXX):</label>
            <input type="text" id="phone" value="254708374149">
            <small>Test number: 254708374149 (use PIN: 123456)</small>
        </div>
        
        <div>
            <label>Customer Name:</label>
            <input type="text" id="name" value="Test Customer">
        </div>
        
        <button onclick="testPayment()">Test Payment</button>
        
        <div id="result" class="result"></div>
    </div>
    
    <script>
    function testPayment() {
        const amount = document.getElementById('amount').value;
        const phone = document.getElementById('phone').value;
        const name = document.getElementById('name').value;
        
        document.getElementById('result').innerHTML = 'Sending payment request...';
        
        fetch('payment.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `amount=${amount}&phone=${phone}&name=${name}`
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response:', data);
            
            if (data.ResponseCode === "0") {
                document.getElementById('result').innerHTML = 
                    '✅ STK Push sent! Check phone for prompt.<br>' +
                    'Checkout ID: ' + data.CheckoutRequestID;
                
                // Start polling for status
                const checkoutID = data.CheckoutRequestID;
                pollPaymentStatus(checkoutID);
                
            } else {
                document.getElementById('result').innerHTML = 
                    '❌ Error: ' + data.ResponseDescription;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('result').innerHTML = 'Network error. Check console.';
        });
    }
    
    function pollPaymentStatus(checkoutID) {
        let pollCount = 0;
        
        const interval = setInterval(() => {
            pollCount++;
            
            if (pollCount > 20) {
                clearInterval(interval);
                document.getElementById('result').innerHTML += 
                    '<br>⏰ Timeout checking payment status';
                return;
            }
            
            fetch(`payment.php?checkoutID=${checkoutID}`)
            .then(res => res.json())
            .then(status => {
                console.log('Status:', status);
                
                if (status.ResultCode === "0") {
                    clearInterval(interval);
                    document.getElementById('result').innerHTML += 
                        '<br>✅ Payment confirmed!';
                } else if (status.ResultCode) {
                    clearInterval(interval);
                    document.getElementById('result').innerHTML += 
                        '<br>❌ Payment failed: ' + status.ResultDesc;
                }
            });
        }, 3000);
    }
    </script>
</body>
</html>
